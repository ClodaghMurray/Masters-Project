---
title: "GSE108565"
author: "Clodagh Murray"
date: "6/12/2022"
output: html_document
---

```{r}
library(GEOquery)
library(limma)
library(dplyr)
library(gplots)
library(Matrix)
library(ggpubr)
library(ggplot2)
library(pheatmap)
library(topGO)
library(Rgraphviz)
library(org.Hs.eg.db)
library(ggplot2)
library(enrichR)
library(enrichplot)
library(DT)
library(biomaRt)
```

# Load in data
Expression data were normalized through quantile normalization, and the Robust Multichip Average (RMA) algorithm was included in the NimbleScan software

```{r}
# load series and platform data from GEO
gset <- getGEO("GSE108565", GSEMatrix =TRUE, AnnotGPL=FALSE)
gset <- gset[[1]]
#write.csv(x = x, file = "/home/clodagh/MASTERS PROJECT/GSE108565.expression.matrix.csv", quote = F, row.names = F) #export expression matrix in file (.csv format).
meta <- pData(gset)
meta <- meta[ ,c("geo_accession","neo-adjuvant chemotherapy:ch1")]
#write.csv(meta , file = "/home/clodagh/MASTERS PROJECT/GSE37614/GSE108565_metadata.csv", quote = F, row.names = F)
```

## General Data pre-processing 
```{r}
sml <- as.character(as.numeric(as.factor(meta$`neo-adjuvant chemotherapy:ch1`)))
gs <- factor(sml)
groups <- meta$`neo-adjuvant chemotherapy:ch1`
orientation <- unique(groups)
levels(gs) <- orientation
gset@phenoData$group <- gs
ord <- order(gs)
palette <- palette(c("#1B9E77", "#7570B3"))
par(mar=c(7,4,2,1))
title <- "GSE108565 Log2 Normalized Signals"
boxplot(exprs(gset[,ord]), boxwex=0.6, notch=T, main=title, outline=FALSE, las=2, col=gs[ord])
legend("topleft",orientation, fill=palette(), bty="n")
```


```{r}
ex <- exprs(gset)
par(mar=c(4,4,2,1))
title <- paste ("Normalized Expression Density", sep ="")
limma::plotDensities(ex, group=gs, main=title, legend ="topright")
```



# Probe Filtering
## Remove multi-mapping probes
```{r}
annotations <- read.table("/home/clodagh/MASTERS PROJECT/GSE108565/A-GEOD-16025.adf.txt", header=T, sep="\t")

mart <- biomaRt::useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
attr <- biomaRt::listAttributes(mart)
genbank_map <- biomaRt::getBM(attributes = c("refseq_mrna", "hgnc_symbol", "gene_biotype"), mart = mart, useCache = FALSE)
genbank_map <- genbank_map[!(is.na(genbank_map$refseq_mrna) | genbank_map$refseq_mrna==""),]
genbank_map <- subset(genbank_map, genbank_map$gene_biotype == "protein_coding")

# merge
master <- merge(genbank_map, annotations, by.x="refseq_mrna", by.y="Reporter.Database.Entry..genbank.")

master_sub <- master[,c(4,2)]
master_sub <- master_sub[!(is.na(master_sub$hgnc_symbol) | master_sub$hgnc_symbol==""),]

# remove multi mapping probes
master_sub <- master_sub %>% distinct(hgnc_symbol, .keep_all = T)
dim(master_sub)
```

```{r}
qnorm <- subset(ex, rownames(ex) %in% master_sub$Reporter.Name)
dim(qnorm)
```

```{r}
master_sub <- master_sub[match(rownames(qnorm), master_sub$Reporter.Name),]
rownames(qnorm) <- master_sub$hgnc_symbol
head(qnorm[1:3,1:3])
write.csv(qnorm, "/home/clodagh/MASTERS PROJECT/GSE37614/GSE108565_qnorm", row.names =T)
```


```{r}
# Probe filtering
medians <- rowMedians(qnorm)
hist(medians, 150, col = "cornsilk1", freq = FALSE, 
             main = "Histogram of the median intensities", 
             border = "antiquewhite4", xlab = "Median intensities")
```



```{r}

lab <- paste(meta$`neo-adjuvant chemotherapy:ch1`)
heatmap.2(cor(qnorm)^2, trace="none", scale="none", margins=c(9,9) )
```

## pca PLot 
```{r}

PCA <- prcomp(t(log2(qnorm)), scale = TRUE)
percentVar <- round(100*PCA$sdev^2/sum(PCA$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])

dataGG <- data.frame(PC1 = PCA$x[,1], PC2 = PCA$x[,2],
                    group = gset$group)

ggscatter(dataGG, x="PC1", y="PC2",
                  color = "group", palette = c("dodgerblue4", "darkorange2", "chartreuse", "purple"),
                  title = "PCA plot log-transformed quantile normalized expression data",
                  subtitle = "Cancer Subtypes",
                  xlab = paste0("PC1, VarExp: ", percentVar[1], "%"),
                  ylab = paste0("PC2, VarExp: ", percentVar[2], "%"),
                  ellipse = T, star.plot = T, 
                  ggtheme = theme_bw()) + 
                  theme(legend.position = "right") + 
                  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```





```{r}
colors <- as.numeric(factor(gset$group))
plotMDS(qnorm, labels=lab, col=colors)
```



# Differential Expression


```{r}
design <- model.matrix(~0 + groups)
colnames(design) <- levels(gs)
aw <- arrayWeights(gset, design)  
barplot(aw)
fit <- lmFit(qnorm, design, weight =aw)  # fit linear model
# set up contrasts of interest and recalculate model coefficients
cts <- "resistant-sensitive"
cont.matrix <- makeContrasts(contrasts=cts, levels=design)
fit2 <- contrasts.fit(fit, cont.matrix)
```

```{r}
# compute statistics and table of top significant genes
fit2 <- eBayes(fit2, 0.01)
```


# Differentially Expressed Genes
```{r}
tT <- topTable(fit2, adjust="fdr", sort.by="B", number=Inf)
tT <- subset(tT, select=c("logFC","adj.P.Val","P.Value","t","B","logFC"))
#write.table(tT, file="/home/clodagh/MASTERS PROJECT/GSE37614/GSE108565_tT.txt", row.names=T, sep="\t")

sig <- tT[tT$adj.P.Val <= 0.05 & abs(tT$logFC)>= 1, ];
#write.table(sig, "GSE108565_DEG_list.csv", sep="\t", row.names=FALSE)

#Extract the expression values for the DEGs
sig_exprs <- qnorm[rownames(qnorm) %in% as.character(rownames(sig)),]
#write.table(sig_exprs, "GSE108565_DEG_counts.csv", sep="\t", row.names=TRUE)
Gene <- rownames(sig_exprs)
dim(sig_exprs)
```

# Visualise DEGs


```{r}
#Create volcano plot for DEGs.
plot(tT$logFC, -log10(tT$adj.P.Val), pch="*", xlab="Log2 Fold Change", ylab="-10log (adjusted p-value)", main = "GSE108565 DEGs")
abline(h=-log10(0.05), v=c(-1, 1), col="red", lty=2)
points(sig$logFC, -log10(sig$adj.P.Val), col="red", pch="*")
```

```{r}

title = "GSE108565 Heatmap of 398 DEGs"
pheatmap(sig_exprs[,ord], trace="none", scale="row", cexRow=0.2, cexCol=0.7, ColSideColors = orientation, show_rownames = F, cluster_cols = T, labels_col = gs, main = title)
```

# Gene Ontology

```{r}
list <- tT$adj.P.Val
names(list) <- rownames(tT)

# selection is function that returns TRUE/FALSE for p-values<0.05
selection <- function(x) TRUE

allGO2genes <- annFUN.org(whichOnto="BP", feasibleGenes=NULL, mapping="org.Hs.eg.db", ID="symbol")

GOdata <- new("topGOdata", ontology="BP", allGenes=list, annot=annFUN.GO2genes, GO2genes=allGO2genes, geneSel=selection, nodeSize=10)

```
## Perform Enrichment 
```{r}
results.ks <- runTest(GOdata, algorithm="classic", statistic="ks")
enrichment_barplot(GOdata, result = results.ks, showTerms = 10, numChar = 40, orderBy = "Scores", y = "Count",  xlab = NULL, ylab = NULL, title = "GSE108565 GO Biological Process")
```


```{r}
goEnrichment <- GenTable(GOdata, KS=results.ks, orderBy="KS", topNodes=20)
goEnrichment$KS <- as.numeric(goEnrichment$KS)
goEnrichment <- goEnrichment[goEnrichment$KS<0.05,]
goEnrichment <- goEnrichment[,c("GO.ID","Term","KS")]
goEnrichment$Term <- gsub(" [a-z]*\\.\\.\\.$", "", goEnrichment$Term)
goEnrichment$Term <- gsub("\\.\\.\\.$", "", goEnrichment$Term)
goEnrichment$Term <- paste(goEnrichment$GO.ID, goEnrichment$Term, sep=", ")
goEnrichment$Term <- factor(goEnrichment$Term, levels=rev(goEnrichment$Term))
write.table(goEnrichment, "/home/clodagh/MASTERS PROJECT/GSE37614/GSE108565_DEGs_GO_Enrichment", sep = "\t", row.names = F)
```

```{r}
DT::datatable(goEnrichment, options = list(scrollX = TRUE, pageLength = 10, scroller = TRUE))
```

```{r}
#Plot the GO graph, color nodes by significance
png("/home/clodagh/MASTERS PROJECT/GSE37614/GSE108565_DEGS_GOdata.png")
showSigOfNodes(GOdata, score(results.ks), firstSigNodes = 5, useInfo = "all")
```
```{r}
require(ggplot2)
ggplot(goEnrichment, aes(x=Term, y=-log10(KS), fill = -log10(KS))) +
    stat_summary(geom = "bar", fun = mean, position = "dodge") +
    ylab("Enrichment (-log10(p-value))") +
    ggtitle("GSE108565 GO Biological Process") +
    scale_y_continuous(breaks = round(seq(0, max(-log10(goEnrichment$KS)), by = 2), 1)) +
    theme_bw(base_size=24) +
    theme(
        legend.position='none',
        legend.background=element_rect(),
        plot.title=element_text(angle=0, size=14, face="bold", vjust=1),
        axis.text.x=element_text(angle=0, size=8, face="bold", hjust=1.10),
        axis.text.y=element_text(angle=0, size=8, face="bold", vjust=0.5),
        axis.title.y = element_blank(),
        axis.title.x =element_text(size=14, face="bold"),
        legend.key=element_blank(),     #removes the border
        legend.key.size=unit(1, "cm"),      #Sets overall area/size of the legend
        legend.text=element_text(size=18),  #Text size
        title=element_text(size=18)) +
        guides(colour=guide_legend(override.aes=list(size=2.5))) +
        
    coord_flip()
```

